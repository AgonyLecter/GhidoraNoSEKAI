<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ghidorah no Sekai — Rare Manga & Comics Showcase | Vintage, Rari, Manga & Comics</title>
<meta name="description" content="Ghidorah no Sekai: vetrina mondiale di manga e fumetti rari, vintage e underground. Acquisto e vendita di albi italiani, americani, giapponesi e cinesi. Edizioni limitate, tirature storiche, pezzi unici.">
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+Antique:wght@700&display=swap" rel="stylesheet" />
<link rel="dns-prefetch" href="https://www.gstatic.com" />
<link rel="dns-prefetch" href="https://firebasestorage.googleapis.com" />
<link rel="dns-prefetch" href="https://wandernatureconnect-default-rtdb.europe-west1.firebasedatabase.app" />
<meta name="theme-color" content="#000000" />
<link rel="canonical" id="canon" href="/" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Ghidorah no Sekai — Rare Manga & Comics Showcase" />
<meta property="og:description" content="Vault di manga e fumetti rari. Vintage, underground, edizioni limitate da Italia, USA, Giappone e Cina." />
<meta property="og:image" content="Ghidorah1.png" />
<meta property="og:locale" content="it_IT" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Ghidorah no Sekai — Rare Manga & Comics Showcase" />
<meta name="twitter:description" content="Comics & manga rari e vintage. Pezzi unici selezionati." />
<meta name="twitter:image" content="Ghidorah1.png" />
<meta name="color-scheme" content="dark" />
<style>
:root{--bg:#000;--gold:#FFD700;--gold-dark:#B8860B;--text:#e6e6e6;--muted:#a0a0a0;--glass:rgba(14,14,14,0.75);--border:rgba(255,215,0,0.18);--ring:rgba(255,215,0,0.55);--shadow-glow:0 0 18px rgba(255,215,0,0.28),0 0 42px rgba(255,215,0,0.16)}
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:'Zen Kaku Gothic Antique',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(1200px 600px at 50% -10%,rgba(255,215,0,0.06),transparent 60%),radial-gradient(900px 500px at -20% 120%,rgba(184,134,11,0.06),transparent 60%),repeating-conic-gradient(from 0deg,rgba(255,255,255,0.012) 0 10deg,transparent 10deg 20deg)}
.topbar{position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;padding:.6rem 1rem;background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,0));backdrop-filter:blur(8px);gap:.75rem}
.brand-mini{display:flex;align-items:center;gap:.6rem}
.brand-mini img{width:28px;height:28px;border-radius:50%}
.rules{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .9rem;border-radius:999px;background:linear-gradient(90deg,#1a1400,#2b2200);border:1px solid rgba(255,215,0,.28);color:#FFD700;font-weight:800;letter-spacing:.08em;text-decoration:none;box-shadow:0 0 12px rgba(255,215,0,.18)}
.searchbar{flex:1;display:flex;align-items:center;gap:.5rem;max-width:560px}
.searchbar input{flex:1;background:#0c0c0c;border:1px solid #222;border-radius:10px;color:#fff;padding:.65rem .8rem;outline:none}
.searchbar input:focus{box-shadow:0 0 0 3px var(--ring)}
header{text-align:center;padding:2rem 1rem 1rem;display:flex;flex-direction:column;align-items:center;gap:1rem}
.logo-wrapper{position:relative;display:inline-block}
.logo-glow{position:absolute;top:50%;left:50%;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(255,215,0,0.65) 0%,rgba(255,215,0,0) 70%);transform:translate(-50%,-50%);filter:blur(14px);z-index:0;animation:pulseGlow 3s ease-in-out infinite}
@keyframes pulseGlow{0%,100%{opacity:.55;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.18)}}
img.logo{position:relative;z-index:1;width:112px;height:112px;border-radius:50%;object-fit:cover;box-shadow:var(--shadow-glow)}
h1{font-size:clamp(2rem,6vw,3rem);background:linear-gradient(90deg,var(--gold),var(--gold-dark),var(--gold));background-size:200% auto;color:transparent;-webkit-background-clip:text;background-clip:text;animation:shine 6s linear infinite;letter-spacing:.12em}
@keyframes shine{0%{background-position:0% center}100%{background-position:200% center}}
.subtitle{font-size:clamp(.9rem,1.8vw,1.05rem);color:var(--muted)}
.jp-bottom{font-size:clamp(1rem,2vw,1.15rem);color:#bbb8;letter-spacing:.5em}
.controls{display:flex;gap:.6rem;justify-content:center;align-items:center;flex-wrap:wrap;padding:.5rem 1rem 0}
.control-chip{background:linear-gradient(180deg,#0d0d0d,#151515);border:1px solid #222;border-radius:999px;padding:.7rem 1rem;color:#cfcfcf;font-size:.9rem;cursor:pointer;user-select:none;min-height:44px}
.control-chip[aria-pressed="true"]{border-color:var(--border);color:var(--gold);box-shadow:0 0 0 2px rgba(255,215,0,0.12) inset}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:clamp(1rem,2vw,2rem);padding:clamp(1rem,4vw,3rem);max-width:1200px;margin:0 auto 3rem}
vault-card{display:block;opacity:0;transform:translateY(40px)}
vault-card.reveal{animation:fadeUp .6s ease forwards}
@keyframes fadeUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
footer{text-align:center;font-size:.85rem;color:#888a;padding:2rem 1rem;border-top:1px solid #222}
.empty{display:grid;place-items:center;gap:.75rem;min-height:220px;border:1px dashed rgba(255,215,0,.25);border-radius:16px;padding:2rem;background:linear-gradient(180deg,#0b0b0b,#0f0f0f);box-shadow:0 0 18px rgba(255,215,0,0.08) inset}
.empty .mark{width:72px;height:72px;border-radius:50%;display:grid;place-items:center;font-size:34px;color:#FFD700;background:radial-gradient(circle at 30% 30%,rgba(255,215,0,.18),rgba(255,215,0,.06));box-shadow:0 0 22px rgba(255,215,0,.2)}
.empty .t1{color:#FFD700;font-weight:800;letter-spacing:.08em}
.empty .t2{color:#bdbdbd;font-size:.95rem}
.skel{background:linear-gradient(180deg,#0d0d0d,#131313);border:1px solid #1e1e1e;border-radius:16px;overflow:hidden;min-height:320px;position:relative}
.skel::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);transform:translateX(-100%);animation:sh 1.6s infinite}
@keyframes sh{to{transform:translateX(100%)}}
.shield{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:999}
.shield.active{display:flex}
.shield .box{border:1px solid #333;border-radius:16px;padding:1.2rem 1.4rem;background:#0b0b0b;max-width:520px;text-align:center;box-shadow:0 0 24px rgba(255,215,0,.14)}
.shield .box h3{margin:0 0 .4rem;color:#FFD700;letter-spacing:.08em}
.shield .box p{margin:.25rem 0;color:#cfcfcf}
@media (max-width:600px){.controls{gap:.5rem}.container{gap:1rem}}
</style>
</head>
<body>
<div class="topbar">
  <div class="brand-mini"><img src="Ghidorah1.png" alt="Ghidorah" /><strong>Ghidorah no Sekai</strong></div>
  <div class="searchbar">
    <input id="q" placeholder="Cerca titolo, autore, serie…" aria-label="Cerca" />
  </div>
  <a href="rules.html" class="rules" aria-label="Regole del Vault">⚖️ Rules</a>
</div>

<header>
  <div class="logo-wrapper" aria-hidden="true">
    <div class="logo-glow"></div>
    <img src="Ghidorah1.png" alt="Logo Ghidorah no Sekai" class="logo" width="112" height="112" />
  </div>
  <h1>Ghidorah no Sekai</h1>
  <div class="subtitle">Rare Manga & Comics Showcase – Underground Vault</div>
  <div class="jp-bottom" aria-label="Gidora no Sekai">ギドラの世界</div>
  <div class="controls" role="group" aria-label="Filtri rapidi">
    <button class="control-chip" id="filter-available" aria-pressed="false">Show available only</button>
    <button class="control-chip" id="sort-rarity" aria-pressed="false">Sort by rarity</button>
  </div>
</header>

<main>
  <section class="container" id="items" aria-live="polite"></section>
</main>

<footer>© 2025 Ghidorah no Sekai – Vintage &amp; Rare Comics Vault</footer>

<script>
class VaultCard extends HTMLElement{
  static get observedAttributes(){return["title","desc","imgs","rarity","stock","total","isnew"]}
  constructor(){
    super();
    this._idx=0; this._slides=[];
    this.attachShadow({mode:"open"});
    this.shadowRoot.innerHTML=`
      <style>
        :host{display:block}
        .card{background:var(--glass);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 0 15px rgba(255,215,0,0.12);display:flex;flex-direction:column;outline:none;transition:transform .25s ease,box-shadow .25s ease,filter .25s ease,opacity .25s ease}
        .card:hover{transform:translateY(-6px) scale(1.01);box-shadow:0 0 28px rgba(255,215,0,0.36)}
        .card:focus-visible{box-shadow:0 0 0 3px var(--ring),0 0 30px rgba(255,215,0,0.4)}

        .media{position:relative;overflow:hidden;aspect-ratio:3/4;background:#0b0b0b}
        .carousel{position:absolute;inset:0}
        .track{display:flex;height:100%;transition:transform .4s ease}
        .slide{min-width:100%;height:100%;position:relative}
        .slide img{width:100%;height:100%;object-fit:cover;display:block}
        .noimg{display:grid;place-items:center;height:100%;background:linear-gradient(180deg,#0d0d0d,#141414)}
        .noimg .glyph{font-size:42px;color:#FFD700;opacity:.9}
        .nav{position:absolute;top:50%;transform:translateY(-50%);border:none;background:rgba(0,0,0,.35);color:#fff;width:38px;height:38px;border-radius:999px;display:none;align-items:center;justify-content:center;cursor:pointer}
        .nav:focus-visible{outline:none;box-shadow:0 0 0 3px var(--ring)}
        .nav.prev{left:.5rem}.nav.next{right:.5rem}
        .dots{position:absolute;left:0;right:0;bottom:.5rem;display:flex;gap:.35rem;justify-content:center}
        .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.35);border:1px solid rgba(255,255,255,.25)}
        .dot[aria-current="true"]{background:#FFD700;box-shadow:0 0 10px rgba(255,215,0,.6)}

        .ring{position:absolute;inset:auto 10px 10px auto;width:72px;height:72px}
        .seal{position:absolute;top:.75rem;right:.75rem;display:inline-flex;align-items:center;gap:.5rem;background:linear-gradient(90deg,#111,#2a2300);border:1px solid var(--border);color:var(--gold);padding:.25rem .5rem;border-radius:999px;font-size:.75rem;letter-spacing:.08em;box-shadow:0 0 10px rgba(255,215,0,0.15);z-index:3}
        .wax{position:absolute;top:10px;left:10px;width:64px;height:64px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#2a0202,#0f0000 60%);border:1px solid #3c0a0a;box-shadow:inset 0 2px 6px rgba(0,0,0,0.5),0 0 12px rgba(0,0,0,0.35);display:none;place-content:center;color:#c44;font-size:26px;line-height:1}
        .tag-new{position:absolute;left:.75rem;top:.75rem;z-index:3;display:none;align-items:center;gap:.4rem;padding:.28rem .55rem;border-radius:999px;background:linear-gradient(90deg,#1a1400,#2b2200);border:1px solid rgba(255,215,0,.28);box-shadow:0 0 16px rgba(255,215,0,.28);color:#FFD700;font-weight:800;letter-spacing:.08em;font-size:.72rem}
        .tag-dot{width:8px;height:8px;border-radius:50%;background:#FFD700;box-shadow:0 0 8px #FFD700,0 0 16px rgba(255,215,0,.6)}

        .content{padding:1.1rem 1.1rem 1.25rem;display:flex;flex-direction:column;gap:.6rem}
        h2{font-size:clamp(1.05rem,2vw,1.25rem);color:var(--gold);line-height:1.2;margin:0}
        p{font-size:clamp(.86rem,1.5vw,1rem);color:#d7d7d7;margin:0}
        .meta{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
        .stars{display:flex;gap:2px}
        .star{color:var(--gold);font-size:1rem;animation:twinkle 2s ease-in-out infinite alternate}
        .star:nth-child(odd){animation-delay:.2s}
        @keyframes twinkle{0%{opacity:.6;transform:scale(1)}100%{opacity:1;transform:scale(1.16)}}
        .badge-qty{font-size:.75rem;color:#bbb;border:1px dashed #333;border-radius:999px;padding:.15rem .5rem}
        .btn{margin-top:.6rem;padding:.72rem 1.05rem;background:linear-gradient(90deg,var(--gold),#e5c100);color:#000;font-weight:800;text-decoration:none;border-radius:10px;text-align:center;transition:transform .2s ease,box-shadow .2s ease,filter .2s ease}
        .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-glow)}
        .btn:focus-visible{outline:none;box-shadow:0 0 0 3px var(--ring),var(--shadow-glow)}

        .soldout .slide img{filter:grayscale(1) contrast(.9) opacity(.85)}
        .soldout .btn{background:linear-gradient(90deg,#444,#666);color:#eaeaea}
        .soldout .seal{color:#aaa;border-color:#333;background:linear-gradient(90deg,#0b0b0b,#151515)}
        .soldout .wax{display:grid}

        @media (hover:hover){.nav{display:flex}}
      </style>
      <article class="card" part="card">
        <div class="media">
          <div class="carousel" part="carousel">
            <div class="track"></div>
            <button class="nav prev" aria-label="Previous">‹</button>
            <button class="nav next" aria-label="Next">›</button>
            <div class="dots" role="tablist"></div>
          </div>
          <div class="tag-new"><span class="tag-dot"></span>FRESH DROP</div>
          <div class="seal" aria-live="polite"></div>
          <div class="wax" title="Sealed — Sold out" aria-hidden="true">🔒</div>
          <div class="ring" aria-hidden="true">
            <svg viewBox="0 0 44 44" width="72" height="72">
              <circle class="track" cx="22" cy="22" r="18" stroke="rgba(255,215,0,0.25)" stroke-width="4" fill="none" />
              <circle class="progress" cx="22" cy="22" r="18" stroke="url(#grad)" stroke-width="4" fill="none" stroke-linecap="round" transform="rotate(-90 22 22)" stroke-dasharray="113.097" stroke-dashoffset="0"/>
              <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#B8860B"/></linearGradient></defs>
            </svg>
          </div>
        </div>
        <div class="content">
          <h2></h2>
          <div class="meta">
            <div class="stars" role="img" aria-label=""></div>
            <span class="badge-qty" aria-live="polite"></span>
          </div>
          <p class="desc"></p>
          <a class="btn" href="#" rel="nofollow noopener"></a>
        </div>
      </article>
    `;
  }
  attributeChangedCallback(){this.render()}
  connectedCallback(){this.render()}
  render(){
    const r=this.shadowRoot;
    const title=this.getAttribute("title")||"";
    const desc=this.getAttribute("desc")||"";
    const imgsAttr=this.getAttribute("imgs")||"[]";
    let imgs=[]; try{imgs=JSON.parse(imgsAttr)}catch{imgs=[]}
    imgs=(Array.isArray(imgs)?imgs:[]).filter(Boolean);
    const rarity=Number(this.getAttribute("rarity")||"0");
    const stock=Number(this.getAttribute("stock")||"0");
    const total=Number(this.getAttribute("total")||stock||1);
    const isNew=this.getAttribute("isnew")==="1";
    const available=stock>0;

    const card=r.querySelector(".card");
    card.classList.toggle("soldout",!available);
    card.classList.toggle("available",available);
    card.tabIndex=0;

    const newTag=r.querySelector(".tag-new");
    newTag.style.display=isNew?"inline-flex":"none";

    const track=r.querySelector(".track");
    const dots=r.querySelector(".dots");
    const prev=r.querySelector(".nav.prev");
    const next=r.querySelector(".nav.next");
    track.innerHTML=""; dots.innerHTML="";
    this._slides = imgs.length? imgs : ["__NOIMG__"];
    this._idx = Math.min(this._idx, this._slides.length-1);
    this._idx = Math.max(this._idx, 0);

    this._slides.forEach((src,i)=>{
      const slide=document.createElement("figure");
      slide.className="slide";
      if(src==="__NOIMG__"){
        slide.innerHTML=`<div class="noimg"><div class="glyph">無</div></div>`;
      }else{
        const im=document.createElement("img");
        im.loading="lazy"; im.decoding="async"; im.width=900; im.height=1200; im.alt=title?`Copertina — ${title}`:"";
        im.src=src;
        slide.appendChild(im);
      }
      track.appendChild(slide);
      const dot=document.createElement("button");
      dot.className="dot"; dot.type="button"; dot.setAttribute("aria-label",`Slide ${i+1}`);
      dot.onclick=()=>this._go(i);
      dots.appendChild(dot);
    });

    const upd=()=>{track.style.transform=`translateX(-${this._idx*100}%)`; [...dots.children].forEach((d,i)=>d.setAttribute("aria-current",String(i===this._idx)))};
    this._go=(i)=>{this._idx=(i+this._slides.length)%this._slides.length; upd()};
    prev.onclick=()=>this._go(this._idx-1);
    next.onclick=()=>this._go(this._idx+1);

    let startX=0, curX=0, dragging=false;
    const onDown=(e)=>{dragging=true; startX=(e.touches?e.touches[0].clientX:e.clientX); curX=startX};
    const onMove=(e)=>{if(!dragging)return; curX=(e.touches?e.touches[0].clientX:e.clientX)};
    const onUp=()=>{if(!dragging)return; const dx=curX-startX; dragging=false; if(Math.abs(dx)>50){ dx<0?this._go(this._idx+1):this._go(this._idx-1)}};
    r.querySelector(".carousel").addEventListener("pointerdown",(e)=>{onDown(e);});
    r.querySelector(".carousel").addEventListener("pointermove",(e)=>{onMove(e);});
    r.querySelector(".carousel").addEventListener("pointerup",(e)=>{onUp(e);});
    r.querySelector(".carousel").addEventListener("touchstart",onDown,{passive:true});
    r.querySelector(".carousel").addEventListener("touchmove",onMove,{passive:true});
    r.querySelector(".carousel").addEventListener("touchend",onUp,{passive:true});
    upd();

    const seal=r.querySelector(".seal");
    if(available){
      const qtyTxt= total>1? `${stock}/${total}` : `1/1`;
      seal.textContent=`AVAILABLE — ${qtyTxt}`;
      seal.setAttribute("aria-label",`Disponibile: ${qtyTxt}`);
    }else{
      seal.textContent="SEALED — SOLD OUT";
      seal.setAttribute("aria-label","Non disponibile");
    }

    const circumference=2*Math.PI*18;
    const progress=r.querySelector(".progress");
    const ratio= total>0? Math.max(0,Math.min(1,stock/total)) : 0;
    const offset=circumference*(1-ratio);
    progress.setAttribute("stroke-dasharray",String(circumference.toFixed(3)));
    progress.setAttribute("stroke-dashoffset",String(offset.toFixed(3)));

    r.querySelector("h2").textContent=title;
    r.querySelector(".desc").textContent=desc;

    const stars=r.querySelector(".stars");
    stars.innerHTML="";
    stars.setAttribute("aria-label",`Rarità ${rarity} su 5 per ${title}`);
    for(let i=0;i<rarity;i++){const s=document.createElement("span");s.className="star";s.textContent="★";stars.appendChild(s)}
    const qty=r.querySelector(".badge-qty");
    qty.textContent=available ? (total>1?`In vault: ${stock}/${total}`:"Unique copy") : "Sealed — join waitlist";

    const btn=r.querySelector(".btn");
    if(available){
      btn.textContent="Contact us";
      btn.href="mailto:ghidorahnosekai@example.com?subject="+encodeURIComponent("Info — "+title);
      btn.setAttribute("aria-label","Contact us for "+title);
    }else{
      btn.textContent="Request restock";
      btn.href="mailto:ghidorahnosekai@example.com?subject="+encodeURIComponent("Waitlist — "+title);
      btn.setAttribute("aria-label","Request restock for "+title);
    }
  }
}
customElements.define("vault-card",VaultCard);
</script>

<script>
window.io=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){e.target.classList.add("reveal");window.io.unobserve(e.target)}})},{rootMargin:"50px"});
document.addEventListener("contextmenu",e=>e.preventDefault(),{passive:!1});
window.addEventListener("keydown",e=>{const t=(e.key||"").toLowerCase();("f12"===t||e.ctrlKey&&"u"===t||e.ctrlKey&&e.shiftKey&&["i","j","c","s"].includes(t))&&(e.preventDefault(),e.stopPropagation())},!0);
const canon=document.getElementById("canon"); try{canon.href=location.href.split('#')[0]}catch{}
(function shield(){
  if(localStorage.getItem("ghidorah_dev_ok")==="1")return;
  const el=document.createElement("div"); el.className="shield"; el.innerHTML='<div class="box"><h3>Vault Shield</h3><p>Protezione attiva.</p><p>Per assistenza scrivi a ghidorahnosekai@example.com</p></div>'; document.body.appendChild(el);
  const check=()=>{const w=window.outerWidth-window.innerWidth;const h=window.outerHeight-window.innerHeight;const open=w>160||h>160; el.classList.toggle("active",open)};
  setInterval(check,700);
})();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig={apiKey:"AIzaSyC7qhjI3lRxqZGbvmTQscetvvhuE8T4N4I",authDomain:"wandernatureconnect.firebaseapp.com",databaseURL:"https://wandernatureconnect-default-rtdb.europe-west1.firebasedatabase.app",projectId:"wandernatureconnect",storageBucket:"wandernatureconnect.appspot.com",messagingSenderId:"1062563433646",appId:"1:1062563433646:web:a7251b914f569fc105f13f",measurementId:"G-SGF0KC717J"};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const container=document.getElementById("items");
const btnFilter=document.getElementById("filter-available");
const btnSort=document.getElementById("sort-rarity");
const qInput=document.getElementById("q");

let filterAvailable=false,sortByRarity=false,cache=[];

renderSkeleton(6);

function renderSkeleton(n){container.innerHTML="";for(let i=0;i<n;i++){const d=document.createElement("div");d.className="skel";container.appendChild(d)}}
function renderEmpty(){container.innerHTML="";const box=document.createElement("div");box.className="empty";box.innerHTML=`<div class="mark">🔒</div><div class="t1">VAULT SEALED</div><div class="t2">Nessun elemento disponibile al momento.</div>`;container.appendChild(box)}

const SEEN_KEY="ghidorah_seen_new_ids";
const seenNew = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || "[]"));
const RECENT_MS = 7*24*60*60*1000;

function markSeen(id){if(!id)return;if(!seenNew.has(id)){seenNew.add(id);localStorage.setItem(SEEN_KEY, JSON.stringify([...seenNew]))}}

const seenIO = new IntersectionObserver(entries=>{entries.forEach(en=>{if(en.isIntersecting){const el=en.target;const id=el.getAttribute("data-id");if(id){markSeen(id);el.removeAttribute("data-new");el.removeAttribute("data-id")}seenIO.unobserve(el)}})},{rootMargin:"0px 0px -20% 0px"});

function updateJsonLd(list){
  document.getElementById("ld-items")?.remove();
  const data = {
    "@context":"https://schema.org",
    "@type":"ItemList",
    "name":"Ghidorah no Sekai — Rare Manga & Comics Showcase",
    "itemListElement": list.map((it,idx)=>({
      "@type":"Product",
      "position": idx+1,
      "name": it.title || "Untitled",
      "description": it.desc || "",
      "image": (Array.isArray(it.imgs) && it.imgs[0]) || it.img || "",
      "brand": {"@type":"Brand","name":"Ghidorah no Sekai"},
      "category":"ComicBook",
      "url": location.href,
      "offers": {
        "@type":"Offer",
        "availability": (it.stock??0)>0 ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
        "priceCurrency":"EUR",
        "price":"0"
      }
    }))
  };
  const s=document.createElement("script"); s.type="application/ld+json"; s.id="ld-items"; s.textContent=JSON.stringify(data); document.head.appendChild(s);
}

function renderList(list){
  container.innerHTML="";
  if(!Array.isArray(list) || list.length===0){ renderEmpty(); updateJsonLd([]); return; }
  list.forEach(item=>{
    const el=document.createElement("vault-card");
    const imgs = Array.isArray(item.imgs) ? item.imgs.filter(Boolean) : (item.img ? [item.img] : []);
    el.setAttribute("title", item.title ?? "Untitled");
    el.setAttribute("desc",  item.desc  ?? "");
    el.setAttribute("imgs",  JSON.stringify(imgs));
    el.setAttribute("rarity",String(item.rarity ?? 1));
    el.setAttribute("stock", String(item.stock  ?? 0));
    el.setAttribute("total", String(item.total  ?? Math.max(1, item.stock || 1)));
    const now=Date.now(); const ts = typeof item.addedAt==="number" ? item.addedAt : 0;
    const fresh = (now - ts) <= RECENT_MS; const showNew = fresh && !seenNew.has(item.id);
    if(showNew){ el.setAttribute("isnew","1"); el.dataset.id=item.id; el.dataset.new="1"; seenIO.observe(el) }
    container.appendChild(el); el.classList.add("reveal"); window.io?.observe?.(el);
  });
  updateJsonLd(list);
}

function applyView(){
  let data = [...cache];
  const term=(qInput.value||"").toLowerCase().trim();
  if (term) data = data.filter(i => ((i.title||"")+ " " + (i.desc||"")).toLowerCase().includes(term));
  if (filterAvailable) data = data.filter(i => (i?.stock ?? 0) > 0);
  if (sortByRarity)    data.sort((a,b)=> (b?.rarity ?? 0) - (a?.rarity ?? 0));
  renderList(data);
}

const itemsRef = ref(db, "items");
const qPub     = query(itemsRef, orderByChild("published"), equalTo(true));

onValue(qPub, (snap) => {
  const obj = snap.val();
  if (obj == null) { cache = []; applyView(); return; }
  const arr = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
  arr.sort((a,b) => (b?.addedAt ?? 0) - (a?.addedAt ?? 0));
  cache = arr;
  applyView();
}, (err) => { renderEmpty(); });

btnFilter?.addEventListener("click", ()=>{ filterAvailable=!filterAvailable; btnFilter.setAttribute("aria-pressed", String(filterAvailable)); applyView(); });
btnSort  ?.addEventListener("click", ()=>{ sortByRarity  =!sortByRarity;   btnSort  .setAttribute("aria-pressed", String(sortByRarity));   applyView(); });
qInput?.addEventListener("input", applyView);
</script>
</body>
</html>





