<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ghidorah — Source Uploader</title>
<meta name="color-scheme" content="dark light" />
<style>
:root{--bg:#0b0b0d;--card:#121216;--ink:#e8e8ea;--muted:#a7a7ad;--brand:#ffd700;--line:#232329;--ok:#23c55e;--warn:#ef4444}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:980px;margin:0 auto;padding:16px}
h1{font-size:1.4rem;margin:10px 0 16px;letter-spacing:.08em;color:var(--brand)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
label{display:block;font-size:.9rem;color:var(--muted);margin:.4rem 0 .25rem}
input[type="text"],input[type="number"],textarea,select{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid #2a2a33;background:#101014;color:#fff;outline:none}
input[type="text"]:focus,textarea:focus,select:focus{box-shadow:0 0 0 3px rgba(255,215,0,.35)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{display:inline-flex;align-items:center;gap:.4rem;padding:.18rem .55rem;border:1px solid #3a3a44;border-radius:999px;background:#15151a;color:#ddd;font-size:.8rem}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button{border:1px solid #35353d;background:#15151a;color:#fff;border-radius:10px;padding:.65rem .9rem;cursor:pointer}
button.primary{background:linear-gradient(90deg,#ffd700,#e6c200);color:#000;border-color:#5c4a00;font-weight:800}
button:disabled{opacity:.6;cursor:not-allowed}
hr{border:none;border-top:1px solid var(--line);margin:10px 0}
#drop{border:1px dashed #3a3a44;border-radius:12px;padding:16px;text-align:center;background:#0f0f13}
#drop.drag{outline:2px solid rgba(255,215,0,.5)}
#thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;margin-top:10px}
.thumb{position:relative;border:1px solid #2a2a33;border-radius:10px;overflow:hidden;background:#0f0f12;display:grid;place-items:center;aspect-ratio:3/4}
.thumb img{max-width:100%;max-height:100%;display:block;object-fit:cover;image-orientation:from-image}
.pbar{position:absolute;left:0;right:0;bottom:0;height:6px;background:#1a1a1f}
.pbar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#4ade80,#22c55e)}
.status{font-size:.92rem}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;margin-top:8px}
code.small{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.8rem;color:#ddd;background:#111114;border:1px solid #2a2a33;border-radius:8px;padding:.35rem .45rem;word-break:break-all}
.list{max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:12px}
.item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:8px 10px;border-bottom:1px solid #1e1e24}
.item:last-child{border-bottom:none}
.item b{color:#eaeaf0}
.ok{color:var(--ok)}.err{color:var(--warn)}
.small{font-size:.86rem;color:#bdbdc4}
</style>
</head>
<body>
<div class="container">
  <h1>Ghidorah — Upload & Publish</h1>

  <div class="grid">
    <div class="card">
      <div class="flex">
        <span class="badge">Project: <b>thcvault-6a800</b></span>
        <span class="badge" id="authState">Auth: <b>anon</b></span>
        <span class="badge" id="bucketState">Bucket ready</span>
      </div>
      <hr />
      <div id="drop" tabindex="0">
        <div>Drop images here or choose files</div>
        <div class="small">JPEG/PNG/WebP • multiple allowed</div>
        <div style="margin-top:8px">
          <input type="file" id="filePick" accept="image/*" multiple />
        </div>
      </div>
      <div id="thumbs"></div>
      <div class="flex" style="margin-top:10px">
        <button id="uploadBtn">Upload images</button>
        <span class="status" id="upStatus"></span>
      </div>
      <hr />
      <label>Or paste external image URLs (one per line)</label>
      <textarea id="extUrls" rows="4" placeholder="https://...jpg
https://...png"></textarea>
    </div>

    <div class="card">
      <label>Title</label>
      <input id="title" type="text" placeholder="L'Uomo Ragno n 6 / Zap Comix #4 / Kaba ..." />
      <label>Description</label>
      <textarea id="desc" rows="5" placeholder="Notes, condition, year, print info"></textarea>
      <div class="row">
        <div>
          <label>Category</label>
          <select id="category">
            <option value="editoriale_corno">Editoriale Corno</option>
            <option value="usa_comics">USA Comics</option>
            <option value="art">Art</option>
            <option value="manga_japanese">Manga (Japanese)</option>
            <option value="manga_italian">Manga (Italian)</option>
            <option value="collectibles">Collectibles</option>
            <option value="misc">Misc</option>
          </select>
        </div>
        <div>
          <label>Language</label>
          <select id="lang">
            <option value="it">Italian</option>
            <option value="en">English</option>
            <option value="ja">Japanese</option>
            <option value="zh">Chinese</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Rarity (1–5)</label>
          <input id="rarity" type="number" min="1" max="5" value="3" />
        </div>
        <div>
          <label>Stock / Total</label>
          <div class="row">
            <input id="stock" type="number" min="0" value="1" />
            <input id="total" type="number" min="1" value="1" />
          </div>
        </div>
      </div>
      <label>Tags (comma separated)</label>
      <input id="tags" type="text" placeholder="Vintage, Limited, First Edition" />
      <div class="flex" style="margin-top:8px">
        <label class="badge"><input id="published" type="checkbox" checked /> Published</label>
        <label class="badge"><input id="isnew" type="checkbox" /> Mark as NEW</label>
      </div>
      <hr />
      <div class="flex">
        <button class="primary" id="publishBtn">Publish item</button>
        <button id="resetBtn">Reset form</button>
        <span class="status" id="pubStatus"></span>
      </div>
      <div class="kv">
        <div>Primary image</div><div><code class="small" id="primaryOut"></code></div>
        <div>Images array</div><div><code class="small" id="arrayOut"></code></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="flex" style="justify-content:space-between">
      <div class="small">Recent uploads</div>
      <button id="refreshBtn">Refresh</button>
    </div>
    <div id="recent" class="list"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref as dbRef, push, set, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
const firebaseConfig={apiKey:"AIzaSyA49iSn7qBR7TaL9q4l8X1a0HmFOaudtxs",authDomain:"thcvault-6a800.firebaseapp.com",databaseURL:"https://thcvault-6a800-default-rtdb.europe-west1.firebasedatabase.app",projectId:"thcvault-6a800",storageBucket:"thcvault-6a800.appspot.com",messagingSenderId:"746310807606",appId:"1:746310807606:web:20ccf6ea569cbf68f0a897",measurementId:"G-GT435NPY50"};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const storage=getStorage(app);

const el=(id)=>document.getElementById(id);
const filePick=el("filePick"), drop=el("drop"), thumbs=el("thumbs"), upStatus=el("upStatus");
const titleEl=el("title"), descEl=el("desc"), categoryEl=el("category"), langEl=el("lang"), rarityEl=el("rarity"), stockEl=el("stock"), totalEl=el("total"), tagsEl=el("tags"), publishedEl=el("published"), isnewEl=el("isnew");
const uploadBtn=el("uploadBtn"), publishBtn=el("publishBtn"), resetBtn=el("resetBtn"), pubStatus=el("pubStatus");
const extUrls=el("extUrls"), primaryOut=el("primaryOut"), arrayOut=el("arrayOut");
const recentBox=el("recent"), refreshBtn=el("refreshBtn");

let files=[], urls=[];

function renderThumbs(){
  thumbs.innerHTML="";
  const all=[...files.map(f=>({type:"file",src:URL.createObjectURL(f),name:f.name})), ...urls.map(u=>({type:"url",src:u}))];
  all.forEach((it,idx)=>{
    const d=document.createElement("div"); d.className="thumb";
    const img=document.createElement("img"); img.alt=""; img.referrerPolicy="no-referrer"; img.decoding="async"; img.loading="lazy"; img.src=it.src;
    const bar=document.createElement("div"); bar.className="pbar"; const i=document.createElement("i"); bar.appendChild(i);
    d.appendChild(img); d.appendChild(bar);
    d.dataset.index=idx; d.dataset.kind=it.type;
    thumbs.appendChild(d);
  });
}

function pickFiles(list){
  for(const f of list){
    if(!f.type.startsWith("image/")) continue;
    files.push(f);
  }
  renderThumbs(); updateOutputs();
}
filePick.addEventListener("change",(e)=>{ pickFiles(e.target.files||[]) });

;["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.add("drag")},{passive:false}));
;["dragleave","drop"].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.remove("drag")},{passive:false}));
drop.addEventListener("drop",(e)=>{e.preventDefault();const dt=e.dataTransfer; if(dt?.files) pickFiles(dt.files)});

function parseExtUrls(){
  const lines=(extUrls.value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  urls=[...new Set(lines)];
  renderThumbs(); updateOutputs();
}
extUrls.addEventListener("blur",parseExtUrls);

function setBar(idx,percent){
  const t=thumbs.children[idx]; if(!t) return;
  const i=t.querySelector(".pbar>i"); if(i) i.style.width=percent+"%";
}

async function uploadAll(){
  if(files.length===0){ upStatus.textContent="No local files to upload"; return; }
  uploadBtn.disabled=true; upStatus.textContent="Uploading…";
  const out=[];
  for(let k=0;k<files.length;k++){
    const f=files[k];
    const path=`items/${Date.now()}_${Math.floor(Math.random()*1e9)}_${encodeURIComponent(f.name)}`.slice(0,750);
    const ref=stRef(storage,path);
    await new Promise((resolve,reject)=>{
      const task=uploadBytesResumable(ref,f,{cacheControl:"public,max-age=31536000,immutable"});
      task.on("state_changed",(snap)=>{
        const pct=Math.round(100*snap.bytesTransferred/snap.totalBytes);
        setBar(k,pct);
      },reject,async()=>{
        const url=await getDownloadURL(task.snapshot.ref);
        out.push(url); resolve();
      });
    });
  }
  urls=[...out, ...urls];
  files=[]; filePick.value="";
  renderThumbs();
  upStatus.textContent=`Uploaded ${out.length} image(s)`;
  updateOutputs();
  uploadBtn.disabled=false;
}

function updateOutputs(){
  primaryOut.textContent=urls[0]||"";
  arrayOut.textContent=urls.length?JSON.stringify(urls):"[]";
}

function parseTags(){
  const raw=(tagsEl.value||"").split(",").map(s=>s.trim()).filter(Boolean);
  return Array.from(new Set(raw));
}

async function publish(){
  const title=(titleEl.value||"").trim();
  if(!title){ pubStatus.textContent="Title required"; pubStatus.className="status err"; return; }
  const data={
    title,
    desc:(descEl.value||"").trim(),
    category:categoryEl.value||"misc",
    lang:langEl.value||"other",
    rarity:Math.max(1,Math.min(5,Number(rarityEl.value||3))),
    stock:Math.max(0,Number(stockEl.value||0)),
    total:Math.max(1,Number(totalEl.value||1)),
    tags:parseTags(),
    published:!!publishedEl.checked,
    addedAt:Date.now()
  };
  if(isnewEl.checked) data.isnew=1;
  if(urls[0]) data.img=urls[0];
  if(urls.length) data.imgs=urls.slice();

  const node=push(dbRef(db,"items"));
  await set(node,data);

  pubStatus.textContent="Published ✓"; pubStatus.className="status ok";
  refreshRecent();
}

function resetForm(){
  titleEl.value=""; descEl.value=""; tagsEl.value="";
  rarityEl.value=3; stockEl.value=1; totalEl.value=1; publishedEl.checked=true; isnewEl.checked=false;
  files=[]; urls=[]; filePick.value=""; extUrls.value="";
  thumbs.innerHTML=""; updateOutputs(); pubStatus.textContent="";
}

async function refreshRecent(){
  recentBox.innerHTML="";
  const q=query(dbRef(db,"items"),limitToLast(20));
  onValue(q,(snap)=>{
    const val=snap.val()||{};
    const list=Object.entries(val).map(([id,v])=>({id,...v})).sort((a,b)=>(b.addedAt||0)-(a.addedAt||0));
    recentBox.innerHTML="";
    list.forEach(it=>{
      const row=document.createElement("div"); row.className="item";
      const left=document.createElement("div");
      const right=document.createElement("div");
      left.innerHTML=`<b>${it.title||"Untitled"}</b><div class="small">${it.category||"-"} • ${it.lang||"-"} • rarity ${it.rarity||"-"}</div>`;
      right.innerHTML=`<span class="small ${it.published?"ok":"err"}">${it.published?"published":"hidden"}</span>`;
      row.appendChild(left); row.appendChild(right);
      recentBox.appendChild(row);
    });
  },{onlyOnce:true});
}

uploadBtn.addEventListener("click",uploadAll);
publishBtn.addEventListener("click",publish);
resetBtn.addEventListener("click",resetForm);
refreshBtn.addEventListener("click",refreshRecent);

refreshRecent();
</script>
</body>
</html>







