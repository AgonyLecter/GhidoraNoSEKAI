<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ghidorah — Vault Source (Admin)</title>
<meta name="color-scheme" content="dark" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+Antique:wght@700&display=swap" rel="stylesheet" />
<style>
:root{--bg:#000;--gold:#FFD700;--text:#e6e6e6;--muted:#9a9a9a;--panel:#0f0f0f;--border:#202020;--ring:rgba(255,215,0,0.55)}
html,body{height:100%}
body{margin:0;font-family:'Zen Kaku Gothic Antique',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:1rem 1.25rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.8),rgba(0,0,0,0));backdrop-filter:blur(8px);z-index:20}
.brand{display:flex;align-items:center;gap:.75rem}
.brand img{width:40px;height:40px;border-radius:50%}
.sub{color:var(--muted);font-size:.9rem}
.btn{background:conic-gradient(from 0deg at 50% 50%,#ffe27a,#e5c100,#ffd84d,#ffe27a);color:#000;font-weight:800;border:none;border-radius:12px;padding:.8rem 1.1rem;cursor:pointer;box-shadow:0 0 16px rgba(255,215,0,.22)}
.btn.dim{background:#171717;color:#ddd;border:1px solid #2a2a2a}
.btn.ghost{background:linear-gradient(90deg,#1a1400,#2b2200);color:#FFD700;border:1px solid rgba(255,215,0,.28)}
main{display:grid;grid-template-columns:420px 1fr;gap:1rem;padding:1rem}
@media (max-width:1100px){main{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:1rem}
.panel h2{margin:.25rem 0 1rem;font-size:1.1rem;color:var(--gold)}
label{display:block;font-size:.9rem;color:#ccc;margin:.5rem 0 .25rem}
input,textarea,select{width:100%;background:#0b0b0b;color:#fff;border:1px solid #2a2a2a;border-radius:10px;padding:.6rem;outline:none}
input:focus,textarea:focus,select:focus{box-shadow:0 0 0 3px var(--ring)}
textarea{min-height:92px;resize:vertical}
.row{display:flex;gap:.5rem}
.row>*{flex:1}
.hint{color:var(--muted);font-size:.85rem}
.grid{display:grid;gap:.6rem}
.item{display:grid;grid-template-columns:72px 1fr auto;gap:.75rem;align-items:center;background:#0b0b0b;border:1px solid #1d1d1d;border-radius:12px;padding:.6rem}
.item img{width:72px;height:96px;object-fit:cover;border-radius:8px}
.stars{color:#FFD700}
.actions{display:flex;gap:.4rem;align-items:center}
.a{padding:.45rem .7rem;border-radius:8px;border:1px solid #2a2a2a;background:#141414;color:#eaeaea;cursor:pointer;min-height:40px}
.a.del{background:#2a0b0b;color:#ffb3b3;border-color:#3a1010}
.toggle{display:inline-flex;align-items:center;gap:.4rem;cursor:pointer}
.toggle input{width:42px;height:22px;appearance:none;background:#2a2a2a;border-radius:999px;position:relative;outline:none;border:1px solid #3a3a3a}
.toggle input:checked{background:#4d3a00;border-color:#705500}
.toggle input::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#ccc;transition:transform .2s ease}
.toggle input:checked::after{transform:translateX(20px);background:#FFD700}
.status{font-size:.8rem;color:#bbb}
.search{display:flex;gap:.5rem;align-items:center}
.fabbar{display:none}
@media (max-width:640px){
main{display:block;padding-bottom:88px}
.fabbar{display:flex;position:fixed;left:0;right:0;bottom:0;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.2),#000);border-top:1px solid #202020;padding:.6rem env(safe-area-inset-left) calc(.6rem + env(safe-area-inset-bottom)) env(safe-area-inset-right);gap:.5rem;justify-content:space-around}
.fabbar .btn{flex:1;min-height:44px}
}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:.5rem;margin-top:.6rem}
.thumb{position:relative;border:1px solid #222;border-radius:10px;overflow:hidden;background:#0c0c0c}
.thumb img{width:100%;height:100%;object-fit:contain;display:block;aspect-ratio:3/4;background:#000}
.thumb .ops{position:absolute;inset:auto .25rem .25rem .25rem;display:flex;gap:.25rem;justify-content:space-between}
.small{font-size:.78rem;padding:.35rem .5rem;border-radius:8px;border:1px solid #2a2a2a;background:#131313;color:#eaeaea;cursor:pointer}
.small.star{border-color:#705500;background:#2b2200;color:#FFD700}
#preview{display:none;width:100%;max-height:260px;object-fit:cover;border-radius:12px;margin-top:.5rem;border:1px solid #222}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="Ghidorah1.png" alt="Ghidorah"/>
    <div>
      <strong>Vault Source (Admin)</strong>
      <div class="sub">Realtime DB + Storage</div>
    </div>
  </div>
  <a class="btn ghost" href="rules.html">⚖️ Rules</a>
</header>

<main>
  <section class="panel" aria-labelledby="formTitle">
    <h2 id="formTitle">Create / Edit Item</h2>
    <form id="form">
      <input type="hidden" id="docId" />
      <label for="title">Title</label>
      <input id="title" required placeholder="Es. Akira #1 (Italia)" />
      <label for="desc">Description</label>
      <textarea id="desc" placeholder="Dettagli, edizione, stato..."></textarea>
      <div class="row">
        <div><label for="rarity">Rarity (1–5)</label><input id="rarity" type="number" inputmode="numeric" min="1" max="5" value="3" required /></div>
        <div><label for="stock">Stock</label><input id="stock" type="number" inputmode="numeric" min="0" value="1" required /></div>
        <div><label for="total">Total</label><input id="total" type="number" inputmode="numeric" min="1" value="1" /></div>
      </div>

      <label>Gallery upload</label>
      <input id="files" type="file" accept="image/*" multiple />
      <div class="row" style="margin-top:.4rem">
        <input id="imgUrl" placeholder="Aggiungi URL singolo come cover (opzionale)" />
        <button type="button" class="btn dim" id="addUrl">Add URL</button>
      </div>
      <div class="gallery" id="gallery"></div>
      <img id="preview" alt="" />

      <div class="row" style="align-items:center;margin-top:.5rem">
        <label class="toggle"><input id="published" type="checkbox"/> <span>Published</span></label>
        <span class="status" id="formStatus"></span>
      </div>

      <div class="row" style="margin-top:.4rem">
        <button type="submit" class="btn" id="saveBtn">Save</button>
        <button type="button" class="btn dim" id="resetBtn">Reset</button>
        <button type="button" class="btn dim" id="deleteBtn" style="display:none">Delete</button>
      </div>
    </form>
  </section>

  <section class="panel" aria-labelledby="listTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem">
      <h2 id="listTitle">Items</h2>
      <div class="search">
        <input id="search" placeholder="Cerca titolo..."/>
        <span class="hint">Ordine: addedAt ↓</span>
      </div>
    </div>
    <div id="list" class="grid"></div>
  </section>

  <div class="fabbar">
    <button type="button" class="btn dim" id="resetBtnMobile">Reset</button>
    <button type="submit" form="form" class="btn" id="saveBtnMobile">Save</button>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onValue, query, orderByChild, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig={apiKey:"AIzaSyC7qhjI3lRxqZGbvmTQscetvvhuE8T4N4I",authDomain:"wandernatureconnect.firebaseapp.com",databaseURL:"https://wandernatureconnect-default-rtdb.europe-west1.firebasedatabase.app",projectId:"wandernatureconnect",storageBucket:"wandernatureconnect.appspot.com",messagingSenderId:"1062563433646",appId:"1:1062563433646:web:a7251b914f569fc105f13f",measurementId:"G-SGF0KC717J"};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const st=getStorage(app);

const form=document.getElementById("form");
const saveBtn=document.getElementById("saveBtn");
const resetBtn=document.getElementById("resetBtn");
const deleteBtn=document.getElementById("deleteBtn");
const statusEl=document.getElementById("formStatus");
const searchEl=document.getElementById("search");
const listEl=document.getElementById("list");

const filesEl=document.getElementById("files");
const imgUrlEl=document.getElementById("imgUrl");
const addUrlBtn=document.getElementById("addUrl");
const galleryEl=document.getElementById("gallery");
const previewEl=document.getElementById("preview");

let gallery=[];

function renderGallery(){
  galleryEl.innerHTML="";
  gallery.forEach((url,idx)=>{
    const t=document.createElement("div");
    t.className="thumb";
    t.innerHTML=`<img src="${url}" alt=""/><div class="ops"><button class="small star" data-cover="${idx}">Cover</button><div><button class="small" data-left="${idx}">◀</button><button class="small" data-right="${idx}">▶</button><button class="small" data-del="${idx}">Del</button></div></div>`;
    galleryEl.appendChild(t);
  });
}

filesEl.addEventListener("change",async e=>{
  const files=[...(e.target.files||[])];
  if(!files.length) return;
  for(const file of files){
    const path=`items/${Date.now()}_${file.name.replace(/[^a-z0-9\\.\\-_]/gi,"_")}`;
    const refS=sRef(st,path);
    const task=uploadBytesResumable(refS,file);
    statusEl.textContent="Uploading…";
    await new Promise((res,rej)=>{
      task.on("state_changed",()=>{},rej,async()=>{const url=await getDownloadURL(task.snapshot.ref); gallery.push(url); res()});
    });
  }
  statusEl.textContent="Upload complete";
  renderGallery();
});

addUrlBtn.addEventListener("click",()=>{
  const u=(imgUrlEl.value||"").trim();
  if(!u) return;
  gallery.push(u);
  imgUrlEl.value="";
  renderGallery();
});

galleryEl.addEventListener("click",(e)=>{
  const cover=e.target.closest("[data-cover]"); const left=e.target.closest("[data-left]"); const right=e.target.closest("[data-right]"); const del=e.target.closest("[data-del]");
  if(cover){ const i=+cover.getAttribute("data-cover"); const [x]=gallery.splice(i,1); gallery.unshift(x); renderGallery(); }
  else if(left){ const i=+left.getAttribute("data-left"); if(i>0){const tmp=gallery[i-1];gallery[i-1]=gallery[i];gallery[i]=tmp;renderGallery()} }
  else if(right){ const i=+right.getAttribute("data-right"); if(i<gallery.length-1){const tmp=gallery[i+1];gallery[i+1]=gallery[i];gallery[i]=tmp;renderGallery()} }
  else if(del){ const i=+del.getAttribute("data-del"); gallery.splice(i,1); renderGallery(); }
});

const itemsRef=ref(db,"items");

form.addEventListener("submit",async e=>{
  e.preventDefault();
  const id=document.getElementById("docId").value.trim();
  const title=document.getElementById("title");
  const desc=document.getElementById("desc");
  const rarity=document.getElementById("rarity");
  const stock=document.getElementById("stock");
  const total=document.getElementById("total");

  if(!title.value.trim()){statusEl.textContent="Title required";setTimeout(()=>statusEl.textContent="",2500);return}
  if(!total.value) total.value=Math.max(1,parseInt(stock.value||"1",10));

  const payload={
    title:title.value.trim(),
    desc:desc.value.trim(),
    img: gallery[0] || "",                 /* cover opzionale */
    imgs: gallery.slice(),                 /* array opzionale */
    rarity:Math.max(1,Math.min(5,parseInt(rarity.value||"1",10))),
    stock:Math.max(0,parseInt(stock.value||"0",10)),
    total:Math.max(1,parseInt(total.value||"1",10)),
    published:document.getElementById("published").checked,
    addedAt: serverTimestamp()
  };

  try{
    saveBtn.disabled=true;
    if(id){
      await update(ref(db,`items/${id}`),payload);
      statusEl.textContent="Updated ✓";
    }else{
      const newRef=push(itemsRef);
      await set(newRef,payload);
      document.getElementById("docId").value=newRef.key;
      statusEl.textContent="Created ✓";
    }
  }catch(err){
    alert(err.message); statusEl.textContent="Error";
  }finally{
    saveBtn.disabled=false;
  }
});

document.getElementById("resetBtnMobile")?.addEventListener("click",()=>resetBtn.click());
document.getElementById("saveBtnMobile")?.addEventListener("click",()=>saveBtn.click());
resetBtn.addEventListener("click",resetForm);
function resetForm(){ form.reset(); document.getElementById("docId").value=""; deleteBtn.style.display="none"; statusEl.textContent=""; previewEl.style.display="none"; gallery=[]; renderGallery(); }

deleteBtn.addEventListener("click",async()=>{
  const id=document.getElementById("docId").value.trim();
  if(!id) return;
  if(!confirm("Delete this item?")) return;
  try{ await remove(ref(db,`items/${id}`)); resetForm(); statusEl.textContent="Deleted ✓"; }
  catch(err){ alert(err.message); }
});

function escapeHtml(s){return (s||"").replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

const q= query(itemsRef, orderByChild("addedAt"));
let cache=[];
onValue(q,snap=>{
  const obj=snap.val()||{};
  const arr=Object.entries(obj).map(([id,v])=>({id,...v}));
  arr.sort((a,b)=> (b.addedAt??0) - (a.addedAt??0));
  cache=arr; renderList(cache);
});

searchEl.addEventListener("input",()=>{
  const term=searchEl.value.toLowerCase();
  const filtered=cache.filter(i=>((i.title||"")+" "+(i.desc||"")).toLowerCase().includes(term));
  renderList(filtered);
});

function renderList(arr){
  listEl.innerHTML="";
  arr.forEach(it=>{
    const row=document.createElement("div");
    row.className="item";
    const when = typeof it.addedAt==="number" ? new Date(it.addedAt).toLocaleString() : "";
    const cover = (Array.isArray(it.imgs) && it.imgs[0]) || it.img || "";
    row.innerHTML=`<img src="${cover}" alt="cover"/><div><div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap"><strong>${escapeHtml(it.title||"Untitled")}</strong><span class="stars">${"★".repeat(it.rarity||0)}</span><span class="hint">${when}</span><span class="pill" title="published">${it.published?"Published":"Draft"}</span><span class="pill" title="stock/total">${it.stock??0}/${it.total??1}</span></div><div class="sub" style="margin-top:.25rem">${escapeHtml((it.desc||"").slice(0,140))}${(it.desc||"").length>140?"…":""}</div></div><div class="actions"><button class="a" data-edit="${it.id}">Edit</button><label class="toggle" title="Toggle publish"><input type="checkbox" ${it.published?"checked":""} data-pub="${it.id}"/></label><button class="a del" data-del="${it.id}">Del</button></div>`;
    listEl.appendChild(row);
  });

  listEl.onclick=async ev=>{
    const edit=ev.target.closest("[data-edit]");
    const del =ev.target.closest("[data-del]");
    const pub =ev.target.closest("[data-pub] input");
    if(edit){
      const id=edit.getAttribute("data-edit");
      const data=cache.find(x=>x.id===id);
      if(!data) return;
      document.getElementById("docId").value=id;
      document.getElementById("title").value=data.title||"";
      document.getElementById("desc").value=data.desc||"";
      document.getElementById("rarity").value=data.rarity||1;
      document.getElementById("stock").value=data.stock||0;
      document.getElementById("total").value=data.total||1;
      document.getElementById("published").checked=!!data.published;
      gallery = Array.isArray(data.imgs) ? data.imgs.slice() : (data.img ? [data.img] : []);
      renderGallery();
      deleteBtn.style.display="inline-block";
      statusEl.textContent=`Editing ${id}`;
      window.scrollTo({top:0,behavior:"smooth"});
    } else if(del){
      const id=del.getAttribute("data-del");
      if(!confirm("Delete this item?")) return;
      try{ await remove(ref(db,`items/${id}`)); } catch(err){ alert(err.message); }
    } else if(pub){
      const id=pub.getAttribute("data-pub");
      try{ await update(ref(db,`items/${id}`),{published:pub.checked}); }
      catch(err){ alert(err.message); pub.checked=!pub.checked; }
    }
  };
}

document.addEventListener("contextmenu",e=>e.preventDefault(),{passive:!1});
window.addEventListener("keydown",e=>{const t=(e.key||"").toLowerCase();("f12"===t||e.ctrlKey&&"u"===t||e.ctrlKey&&e.shiftKey&&["i","j","c","s"].includes(t))&&(e.preventDefault(),e.stopPropagation())},!0);
</script>
</body>
</html>

